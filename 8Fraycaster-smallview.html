<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <link rel="stylesheet" href="./css/8Fraycaster.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
</head>
<body>
  <footer>
    <div class="logo"><img src="./img/LOGO(白透).png" alt=""></div>
    <ul class="btn-group">
      <a href="index.html">
        <li class="btn">
          <i class="fa-solid fa-arrow-left left"></i>
          回到首頁
        </li>
      </a>
      <a href="#">
        <li class="btn">
          漫步八樓
          <i class="fa-solid fa-arrow-right right"></i>
        </li>
      </a>
    </ul>
  </footer>
  <div class="OBJview"><div class="closebutton">關閉</div></div>
  <div class="BakingRoom label">烘焙教室</div>

  <script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
  <script type="importmap">
    {
    "imports": {
      "three": "https://unpkg.com/three@latest/build/three.module.js",
      "three/addons/": "https://unpkg.com/three@latest/examples/jsm/"
    }
    }
  </script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script type="module">
    import * as THREE from 'three';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
    import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
    import { DRACOLoader } from 'three/addons/loaders/DRACOLoader.js';
    import { CSS2DRenderer, CSS2DObject } from 'three/addons/renderers/CSS2DRenderer.js';
    // 場景及顏色
    const scene = new THREE.Scene();
    const color = new THREE.Color(0x76c7fb);
    scene.background = color;   
        // 燈光
    // 環境光
    // const light = new THREE.AmbientLight( 0x404040,10 );
    // scene.add( light );
    // 半球光
    const hemispherelight = new THREE.HemisphereLight( 0x404040, 0x404040, 5 );
    const hemispherehelper = new THREE.HemisphereLightHelper( hemispherelight, 5 );
    hemispherelight.position.set(0, 30, 0);
    scene.add( hemispherelight );
    scene.add( hemispherehelper );
    // 聚光燈
    const spotLight = new THREE.SpotLight( 0xffffff );
    spotLight.power = 2000;
    spotLight.angle = 0.75;
    const spotLightHelper = new THREE.SpotLightHelper( spotLight );
    spotLight.position.set(-10,15,-50);
    // scene.add( spotLight );
    // 輔助
    const axesHelper = new THREE.AxesHelper( 50 );
    scene.add( axesHelper );
    const gridHelper = new THREE.GridHelper(20, 100);
    scene.add(gridHelper);
    // 射線
    const raycaster = new THREE.Raycaster();
    const pointer = new THREE.Vector2();
    // 相機
    const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 100000 );
    const BakingCamera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );
    let camIndex = 0;
    const cameras = [
      {
        name: '上帝視角',
        camera: camera,
      },
      {
        name: '烘焙教室',
        camera: BakingCamera,
      },
    ];

    camera.position.set(1,1,1);

// 物件
let AllObj=[];
      // 8F樓板
// Instantiate a loader
const loader = new GLTFLoader();

// Optional: Provide a DRACOLoader instance to decode compressed mesh data
const dracoLoader = new DRACOLoader();
dracoLoader.setDecoderPath( '/examples/jsm/libs/draco/' );
loader.setDRACOLoader( dracoLoader );

// Load a glTF resource
loader.load(
	// resource URL
	'./models1023/PlaneAllCube.glb',
	// called when the resource is loaded


  
	function ( gltf ) {
        console.log(gltf.scene  );
		scene.add(gltf.scene);
        // gltf.scene.children[16].material.color={r:9,b:2,g:2}
        // gltf.scene.children[8].color.b=10
        // gltf.scene.children[8].power=20
		gltf.animations; // Array<THREE.AnimationClip>
		gltf.scene; // THREE.Group
		gltf.scenes; // Array<THREE.Group>
		gltf.cameras; // Array<THREE.Camera>
		gltf.asset; // Object

    // resize用於RWD
    window.addEventListener('resize', resetSetting);
    window.addEventListener('mousemove', mouseMove);
    // window.addEventListener('click', mouseClick);

      function pointerSetting(event) {
      pointer.x = ( event.clientX / window.innerWidth ) * 2 - 1;
	    pointer.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
    }

    // function mouseClick(event) {
    //   pointerSetting(event);
    //   raycaster.setFromCamera( pointer, cameras[camIndex].camera );
    //   const intersects = raycaster.intersectObjects( gltf.scene.children,true );
    //   if (intersects.length > 0) {
    //     gltf.scene.children[0].material.color={r:2,b:2,g:2}
    //   } else {
    //     gltf.scene.children[0].material.color={r:2,b:2,g:2}
    //   }
    // }

    const one=[gltf.scene.children[0]];
    const two=[gltf.scene.children[1]];
    console.log(one);
    function mouseMove(event) {
      pointerSetting(event);
      raycaster.setFromCamera( pointer, cameras[camIndex].camera );
      const intersects = raycaster.intersectObjects( one, true );
      const intersects2 = raycaster.intersectObjects( two, true );
      if (intersects.length > 1 ) {
        gltf.scene.children[0].material.color={r:15,b:2,g:2}
      } else {
        gltf.scene.children[0].material.color={r:1,b:1,g:1}
      }
      if (intersects2.length > 1 ) {
        gltf.scene.children[1].material.color={r:15,b:2,g:2}
      } else {
        gltf.scene.children[1].material.color={r:1,b:1,g:1}
      }
    }
    function resetSetting() {
      renderer.setSize( window.innerWidth, window.innerHeight );
      labelRenderer.setSize(window.innerWidth, window.innerHeight);
      cameras.forEach((item) => {
        item.camera.aspect = window.innerWidth / window.innerHeight;
        item.camera.updateProjectionMatrix();
      });
    }

    
	},
	// called while loading is progressing
	function ( xhr ) {
		console.log( ( xhr.loaded / xhr.total * 100 ) + '% loaded' );
	},
	// called when loading has errors
	function ( error ) {
		console.log( 'An error happened' );
	}
);
    // 主畫面渲染
    const renderer=new THREE.WebGLRenderer({
      antialias: true,    //是否開啟反鋸齒
      precision:" highp", //highp/mediump/lowp 著色的精準度選擇，分別為高/中/低
      alpha: true,        //是否設置背景色透明
      premultipliedAlpha: false,  //是否設置Alpha著色透明度
      stencil: false, //是否開啟繪圖緩衝組成
      preserveDrawingBuffer: true, //是否保存繪圖緩衝
      maxLights:1         //maxLights:最大燈光數
    });
    renderer.setSize( window.innerWidth, window.innerHeight );
    document.body.appendChild( renderer.domElement,);
    // 標籤渲染
    const labelRenderer = new CSS2DRenderer();
    labelRenderer.setSize(window.innerWidth, window.innerHeight);
    labelRenderer.domElement.style.position = "absolute";
    labelRenderer.domElement.style.pointerEvents = "none";
    labelRenderer.domElement.style.top = "0px";
    document.body.appendChild(labelRenderer.domElement);
    

    // 滑鼠控制器
    const controls = new OrbitControls( camera, renderer.domElement );
    // const controlsx = new OrbitControls( BakingCamera, renderer.domElement );
    function animate() {
      requestAnimationFrame( animate );
      // console.log('相機'+camIndex);
      // if(camIndex===0){scene.rotation.y += 0.002;}else{
      //   scene.rotation.y=0;
      // }
      renderer.render( scene, cameras[camIndex].camera );
      labelRenderer.render(scene, cameras[camIndex].camera );
    }
    
    animate();

  </script>


</body>
</html>