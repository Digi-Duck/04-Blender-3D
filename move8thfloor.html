<!DOCTYPE html>
<html lang="en">

<head>
	<title>three.js - misc - octree collisions</title>
	<meta charset=utf-8 />
	<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
	<!-- <link type="text/css" rel="stylesheet" href="main.css"> -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
	<link rel="stylesheet" href="./css/move8thfloor.css">

</head>


<body>
	<div class="loading">
		<div class="cubeGrid">
			<div class="cube cube1"></div>
			<div class="cube cube2"></div>
			<div class="cube cube3"></div>
			<div class="cube cube4"></div>
			<div class="cube cube5"></div>
			<div class="cube cube6"></div>
			<div class="cube cube7"></div>
			<div class="cube cube8"></div>
			<div class="cube cube9"></div>
		  </div>
		<div class="loadingCalcBox" >
			<span class="loadingCalcName">載入中</span>
			<div class="loadingBar"><div class="loadingBarColor"></div></div>
			<div class="loadingCalc">0</div></div>
	</div>
	
	<nav class="navbar navbar-expand-lg  position-absolute top-0">
		<div class="container-fluid ">
			<a class="col" href="index.html"><img class="logo" src="./img/LOGO(橫白透).png" width="200" alt=""></a>
		</div>
	</nav>
	<a class="leaveBtn" href="watch8thfloor copy.html"><img src="./img/logout.png" alt=""></a>
	<div id="container" class="bg-light"></div>
	<div id="startBtn">點擊進入</div>
	<div onclick="myFunction()" class="question"></div>
	<div id="container-md"
		class="overflow-hidden text-center position-absolute bottom-0 start-50 translate-middle-x">
		<div class="row gx-5">
			<div class="col ">
				<div class="p-3"><img src="./img/letter-w.png" alt="">
					<div class="card-body">前進</div>
				</div>
			</div>
			<div class="col ">
				<div class="p-3"><img src="./img/letter-a.png" alt="">
					<div class="card-body">往左</div>
				</div>
			</div>
			<div class="col">
				<div class="p-3"><img src="./img/letter-s (2).png" alt="">
					<div class="card-body">後退</div>
				</div>
			</div>
			<div class="col ">
				<div class="p-3"><img src="./img/letter-d (1).png" alt="">
					<div class="card-body">往右</div>
				</div>
			</div>
		</div>
	</div>




	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script async src="https://unpkg.com/es-module-shims@1.8.0/dist/es-module-shims.js"></script>
	<script type="importmap">
        {
        "imports": {
        "three": "https://unpkg.com/three@latest/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@latest/examples/jsm/"
        }
        }
    </script>
	<script>
		const questionBtn = document.querySelector('.question');
		// const operate = document.querySelector('#container-md');
		const startBtn = document.querySelector('#startBtn');


		// questionBtn.addEventListener('click', function (e) {
		// 	operate.style.display = 'block';
		// });

		function myFunction() {
			document.getElementById("container-md").classList.toggle('hide');
			// document.getElementById("startBtn").classList.remove('hide');
		};



	</script>

	<script type="module">
		import * as THREE from 'three';
		import Stats from 'three/addons/libs/stats.module.js';
		import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
		import { Octree } from 'three/addons/math/Octree.js';
		import { Capsule } from 'three/addons/math/Capsule.js';
		
		const clock = new THREE.Clock();
		const scene = new THREE.Scene();
		scene.background = new THREE.Color(0x88ccee);
		const camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.1, 1000);
		camera.rotation.order = 'YXZ';
		const sphereLight = new THREE.HemisphereLight(0x8dc1de, 0x00668d, 1.5);
		sphereLight.position.set(2, 1, 1);
		scene.add(sphereLight);
		const directionalLight = new THREE.DirectionalLight(0xffffff, 2.5);
		directionalLight.position.set(- 5, 25, - 1);
		scene.add(directionalLight);
		const container = document.getElementById('container');
		const renderer = new THREE.WebGLRenderer({ 
			antialias: true,
			precision: " highp",
		});
		renderer.setPixelRatio(window.devicePixelRatio);
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.shadowMap.enabled = true;
		renderer.shadowMap.type = THREE.VSMShadowMap;
		renderer.toneMapping = THREE.ACESFilmicToneMapping;
		container.appendChild(renderer.domElement);
		const GRAVITY = 30;
		const STEPS_PER_FRAME = 5;
		const worldOctree = new Octree();
		const playerCollider = new Capsule(new THREE.Vector3(0, 0.35, 0), new THREE.Vector3(0, 2.7, 0), 0.35);
		const playerVelocity = new THREE.Vector3();
		const playerDirection = new THREE.Vector3();
		let playerOnFloor = false;
		let mouseTime = 0;
		const keyStates = {};
		startBtn.addEventListener('mousedown', () => {
			document.getElementById("startBtn").classList.add('hide');
			document.getElementById("container-md").classList.add('hide');
			document.body.requestPointerLock();
			mouseTime = performance.now();
			});
		document.body.addEventListener('mousemove', (event) => {
			if (document.pointerLockElement === document.body) {
				camera.rotation.y -= event.movementX / 500;
				camera.rotation.x -= event.movementY / 500;
				document.addEventListener('keydown', (event) => {
				keyStates[event.code] = true;
				});
				document.addEventListener('keyup', (event) => {
				keyStates[event.code] = false;
				});
			}else{
				document.getElementById("startBtn").classList.remove('hide');
				document.addEventListener('keydown', (event) => {
				keyStates[event.code] = false;
				});
			}
		});
		window.addEventListener('resize', onWindowResize);
		function onWindowResize() {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
		}
		function playerCollisions() {
			const result = worldOctree.capsuleIntersect(playerCollider);
			playerOnFloor = false;
			if (result) {
				playerOnFloor = result.normal.y > 0;
				if (!playerOnFloor) {
					playerVelocity.addScaledVector(result.normal, - result.normal.dot(playerVelocity));
				}
				playerCollider.translate(result.normal.multiplyScalar(result.depth));
			}
		}

		function updatePlayer(deltaTime) {
			let damping = Math.exp(- 4 * deltaTime) - 1;
			if (!playerOnFloor) {
				playerVelocity.y -= GRAVITY * deltaTime;
				damping *= 0.1;
			}
			playerVelocity.addScaledVector(playerVelocity, damping);
			const deltaPosition = playerVelocity.clone().multiplyScalar(deltaTime);
			playerCollider.translate(deltaPosition);
			playerCollisions();
			camera.position.copy(playerCollider.end);
		}

		function getForwardVector() {
			camera.getWorldDirection(playerDirection);
			playerDirection.y = 0;
			playerDirection.normalize();
			return playerDirection;
		}

		function getSideVector() {
			camera.getWorldDirection(playerDirection);
			playerDirection.y = 0;
			playerDirection.normalize();
			playerDirection.cross(camera.up);
			return playerDirection;
		}

		function controls(deltaTime) {
			// gives a bit of air control
			const speedDelta = deltaTime * (playerOnFloor ? 25 : 8);
			if (keyStates['KeyW']) {
				playerVelocity.add(getForwardVector().multiplyScalar(speedDelta));
			}
			if (keyStates['KeyS']) {
				playerVelocity.add(getForwardVector().multiplyScalar(- speedDelta));
			}
			if (keyStates['KeyA']) {
				playerVelocity.add(getSideVector().multiplyScalar(- speedDelta));
			}
			if (keyStates['KeyD']) {
				playerVelocity.add(getSideVector().multiplyScalar(speedDelta));
			}
		}

		const loader = new GLTFLoader();
		loader.load('./models/1031MoveCollision.glb', (gltf) => {
			scene.add(gltf.scene);
			worldOctree.fromGraphNode(gltf.scene);
			gltf.scene.traverse(child => {
				if (child.isMesh) {
					child.castShadow = true;
					child.receiveShadow = true;
					if (child.material.map) {
						child.material.map.anisotropy = 4;
					}
				}
			});
			const planeLoader = new GLTFLoader();
			planeLoader.load(
				'./models/1031MoveView.glb',
				function (gltf) {
					console.log(gltf.scene.children);
					scene.add(gltf.scene);
				},
				function ( xhr ) {
				const loading = document.querySelector('.loading');
				const loadingCalc = document.querySelector('.loadingCalc');
				const loadingCalcName = document.querySelector('.loadingCalcName');
				const loadingBarColor = document.querySelector('.loadingBarColor');
				var number= ( xhr.loaded / xhr.total * 100 ).toFixed(1);
				loadingCalc.textContent = number;
				loadingBarColor.style.width=number+ '%';
				if(number == 100.0){
					loadingCalcName.textContent ='載入完成';
					loadingCalcName.style.color = 'lightgreen';
					loadingCalc.style.color = 'lightgreen';
					let timeRun = 2;
					let timerA = setInterval(function () {
							timeRun-- ;
							if (timeRun <= 0) {
							clearTimeout(timerA);
							loading.style.display = 'none';
							}
						}, 1000);
				}
				},
				
				)

			animate();

		});

		function teleportPlayerIfOob() {
			if (camera.position.y <= - 25) {
				playerCollider.start.set(0, 0.35, 0);
				playerCollider.end.set(0, 1, 0);
				playerCollider.radius = 0.35;
				camera.position.copy(playerCollider.end);
				camera.rotation.set(0, 0, 0);
			}
		}


		function animate() {
			const deltaTime = Math.min(0.05, clock.getDelta()) / STEPS_PER_FRAME;
			for (let i = 0; i < STEPS_PER_FRAME; i++) {
				controls(deltaTime);
				updatePlayer(deltaTime);
				teleportPlayerIfOob();
			}
			renderer.render(scene, camera);
			requestAnimationFrame(animate);
		}



	</script>
</body>

</html>